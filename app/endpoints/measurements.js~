(function() {
    'use strict';

    angular
        .module('app.endpoints')
        .controller('MeasurementsController', MeasurementsController);

    function MeasurementsController($http, $scope, URLService) {
        var uri = URI(URLService.getOpenAQUrl('measurements'));
        $scope.query_url = uri.toString();
        $scope.limit = 10;
        $scope.page = 1;
        $scope.order_by = "date";
        $scope.sort = "desc"
        $scope.busy = 0;

        $scope.updateUrl = function(model) {
            $scope.query_url = URLService.updateUrl(uri, model, $scope[model]);
        };

        var setDefaults = function(uri) {
            var defaultFields = [
                'limit',
                'page',
                'order_by',
                'sort'
            ]

            for (var i in defaultFields) {
                $scope.updateUrl(defaultFields[i]);
            }
        };
        setDefaults();
        
        $scope.get_locations = function() {
            var uri = URI(URLService.getOpenAQUrl('locations'));
            if($scope.country) {
                uri.addQuery("country", $scope.country);
            }
            if($scope.city){
                uri.addQuery("city", $scope.city);
            };
            
            $http.get(uri.toString())
                .success(function(data){
                    $scope.locations = data.results;
                });
        };

        $scope.get_cities = function() {
            var uri = URI(URLService.getOpenAQUrl('cities'));
            if($scope.country){
                uri.addQuery('country', $scope.country);
            }
            $http.get(uri.toString())
                .success(function(data){
                    $scope.cities = data.results;
                });
        };

        $scope.get_countries = function() {
            var uri = URI(URLService.getOpenAQUrl('countries'));
            $http.get(uri.toString())
                .success(function(data){
                    $scope.countries = data.results;
                });
        };
        $scope.get_countries();

        $scope.fetch = function() {
            $scope.busy = 1;

            $http.get($scope.query_url).success(function(data) {
                $scope.results = data.results;
                $scope.found = data.meta.found;
                $scope.limit = data.meta.limit;

                $scope.busy = 0;
            });
        };

        $scope.submit = function() {
            $scope.fetch()
        };

        $scope.get_csv = function() {
            $scope.busy = 1;

            $scope.query_url += "&format=csv";

            $http.get($scope.query_url).success(function(data) {
                // http://stackoverflow.com/a/31871521
                var anchor = angular.element('<a/>');
                anchor.css({display: 'none'}); // Make sure it's not visible
                angular.element(document.body).append(anchor); // Attach to document

                anchor.attr({
                    href: 'data:attachment/csv;charset=utf-8,' + encodeURI(data),
                    target: '_blank',
                    download: 'filename.csv'
                })[0].click();

                anchor.remove(); // Clean it up afterwards
                $scope.busy = 0;
            });
        };
    };
})();
