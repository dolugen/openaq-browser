(function() {
    'use strict';

    angular
        .module('app.endpoints')
        .controller('LatestController', CountriesController);

    /* ngInject */
    function LatestController($http, $scope, URLService) {
        var uri = URI(URLService.getOpenAQUrl('latest'));
        $scope.query_url = uri.toString();
        $scope.busy = 0;

        $scope.updateUrl = function(model) {
            $scope.query_url = URLService.updateUrl(uri, model, $scope[model]);
        };

        $scope.get_locations = function() {
            var uri = URI(URLService.getOpenAQUrl('locations'));
            uri.addQuery('country', $scope.country);
            if($scope.city){
                uri.addQuery('city', $scope.city);
            };
            
            $http.get(uri)
                .success(function(data){
                    $scope.locations = data.results;
                });
        };

        $scope.get_cities = function() {
            var uri = URI(URLService.getOpenAQUrl('cities'));
            uri.addQuery('country', $scope.country);

            $http.get(uri)
                .success(function(data){
                    $scope.cities = data.results;
            });
        };

        $scope.get_countries = function() {
            var uri = URI(URLService.getOpenAQUrl('countries'));

            $http.get(uri)
                .success(function(data){
                    $scope.countries = data.results;
                });
        };
        $scope.get_countries();

        $scope.fetch = function() {
            $scope.busy = 1;

            $http.get($scope.query_url).success(function(data) {
                $scope.results = data.results;
                $scope.found = data.results.length;

                $scope.busy = 0;
            });
        };


        $scope.submit = function() {
            $scope.fetch()
        };
    }
})();

